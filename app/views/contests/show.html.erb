<% if !user_signed_in? %>
  <%= render 'layouts/navbar1'%>
<%end%>

<div class="container main-wall">
  <div class="row">
    <!-- Leftbar  -->
    <div class="col-xs-2">
      <%= render 'layouts/leftbar'%>
    </div>

    <!-- Contests area -->
    <div class="col-xs-7">
      <div class="contests-area">
        <% if @is_admin %>
          <div class="row">
            <div class="col-xs-8">
              <h3>Showing contests you posted</h3>
            </div>
            <div class="col-xs-2">
              <button class="btn btn-default" style="margin-top: 1em;" data-toggle="modal" data-target="#contestModal">Start a Contest</button>
            </div>
          </div>
        <% else %>
          <h3>Showing all contests</h3>
        <% end %>

        <% @contests.each do |contest| %>
          <%= render 'contest', :contest => contest, :is_admin => @is_admin %>
        <% end %>
      </div>
    </div>

    <!-- Suggestions -->
    <div class="col-xs-3">
      <%= render 'layouts/suggestions'%>
    </div>
  </div>
</div>

<!-- Posting contest modal -->
<div class="modal bnr-modal fade" id="contestModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="row">
          <div class="col-xs-10">
           <h4>New Contest</h4>
          </div>
          <div class="col-xs-2">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
        </div>
      </div>
      <section>
        <div class="modal-body modal-spa">
          <% @contest = Contest.new %>
          <%= form_for @contest,:url =>{ :controller =>"contests", :action =>"create"}  do |f| %>
          <div class="form-group">
            <div class="row" style="padding-top:1em;">
              <div class="col-xs-6">
                <p><strong>Contest header</strong></p>
                <%= f.text_field :content, autofocus: true, class: 'question-ask-field form-control',placeholder: 'What do you want to ask?'%> <br>
              </div>
              <div class="col-xs-6">
                <p><strong>Winning prize</strong></p>
                <%= f.text_field :prize, class: 'form-control', placeholder: 'Whats the winning prize' %>
              </div>
            </div>

            <div class="row">
              <div class="col-xs-5 col-xs-offset-1">
                <p><strong>Contest detail</strong></p>
                <%= f.text_area :detail, cols: 20, rows: 3, class: 'question-detail form-control', placeholder: 'Please provide some detail' %>
              </div>
              <div class="col-xs-6">
                <p><strong>Please select end date</strong></p>
                <%= f.date_select :end_date %>
              </div>
            </div>
          </div>
          <!-- for image upload -->
          <div class="row" style="border-left: 1px solid #e7e7e7;">
            <center>
              <%= f.file_field :image,class: 'btn' %> <br>
              <%= f.submit "Post Contest",class:'btn btn-squared btn-ask1'%>
            </center>
          </div>
          <%end%>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Editing contest modal -->
<div class="modal bnr-modal fade" id="editContestModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="row">
          <div class="col-xs-10">
            <h4>Contest</h4>
          </div>
          <div class="col-xs-2">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
        </div>
      </div>
      <section>
        <div class="modal-body modal-spa">
          <form enctype="multipart/form-data" onsubmit="event.preventDefault();">
            <input id="new_contest_content" type="text" class="form-control">
            <textarea id="new_contest_detail" class="form-control"></textarea>
            <br>

            <center>
              <input id="new_contest_submit" type="submit" value="Update Contest" class="btn btn-squared btn-ask1" />
            </center>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>


<script type="text/javascript">
  // Editing a contest
  $("[id^=edit_contest").click(function() {
    contest_id = this.id.substring(12, this.id.length)
    console.log('contest id '+contest_id)
    $("#new_contest_content").val($('#contest_content'+contest_id).val())
    $("#new_contest_detail").val($('#contest_detail'+contest_id).text())
    $('#editContestModal').modal('show');
  })

  // Updating a contest
  $("#new_contest_submit").click(function() {
  const contest_content = $("#new_contest_content").val()
  const contest_detail = $("#new_contest_detail").val()

  // Sending ajax request to follow the contest
  $.ajax({
    url: "/update_contest",
    type: "POST",
    data: {
      contest_id: contest_id,
      contest_content: contest_content,
      contest_detail: contest_detail
    },
    dataType: "json",
    complete: function() {},
    success: function(data, textStatus, xhr) {
      $('#editContestModal').modal('hide')

      if (data.status.localeCompare("success") == 0) {
        alert("updated")
        location.reload()
      } else {
        alert("failed to update")
      }
    },
    error: function() {
      alert("error")
    }
  })
})
</script>